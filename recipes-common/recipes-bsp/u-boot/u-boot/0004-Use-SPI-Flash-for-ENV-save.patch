From fe3fd6af39ccea2ef1a317e6c34e759cae69ce68 Mon Sep 17 00:00:00 2001
From: Stanimir Bonev <bonev.stanimir@gmail.com>
Date: Sat, 22 Jul 2023 20:35:37 +0300
Subject: [PATCH] Use SPI Flash for ENV save

---
 board/renesas/vkrzv2l/Kconfig | 8 ++++++++
 configs/vkrzv2l_defconfig | 22 +++++++++++++++++-----
 include/configs/vkrzv2l.h | 4 ++--
 3 files changed, 27 insertions(+), 7 deletions(-)

diff --git a/board/renesas/vkrzv2l/Kconfig b/board/renesas/vkrzv2l/Kconfig
index d95715af38..4078f76454 100644
--- a/board/renesas/vkrzv2l/Kconfig
+++ b/board/renesas/vkrzv2l/Kconfig
@@ -12,5 +12,13 @@ config SYS_VENDOR
 config SYS_CONFIG_NAME
         default "vkrzv2l"
 
+config SYS_MMC_DEV
+	int
+	default 0
+
+config SYS_MMC_IMG_LOAD_PART
+	int
+	default 1
+
 endif

diff --git a/configs/vkrzv2l_defconfig b/configs/vkrzv2l_defconfig
index a933ab08cd..d610cf893e 100644
--- a/configs/vkrzv2l_defconfig
+++ b/configs/vkrzv2l_defconfig
@@ -2,8 +2,9 @@ CONFIG_ARM=y
 CONFIG_ARCH_CPU_INIT=y
 CONFIG_ARCH_RMOBILE=y
 CONFIG_SYS_TEXT_BASE=0x50000000
-CONFIG_ENV_SIZE=0x20000
-CONFIG_ENV_OFFSET=0xFFFE0000
+CONFIG_ENV_SIZE=0x2000
+CONFIG_ENV_OFFSET=0x1FFE000
+CONFIG_ENV_SECT_SIZE=0x1000
 CONFIG_DM_GPIO=y
 CONFIG_RCAR_GEN3=y
 CONFIG_R9A07G054L=y
@@ -23,6 +24,7 @@ CONFIG_HUSH_PARSER=y
 CONFIG_CMD_BOOTZ=y
 CONFIG_CMD_GPIO=y
 CONFIG_CMD_I2C=y
+CONFIG_CMD_SPI=y
 CONFIG_CMD_MMC=y
 CONFIG_CMD_PCI=y
 CONFIG_CMD_USB=y
@@ -36,7 +38,7 @@ CONFIG_CMD_FAT=y
 CONFIG_CMD_FS_GENERIC=y
 CONFIG_OF_CONTROL=y
 CONFIG_ENV_OVERWRITE=y
-CONFIG_ENV_IS_IN_MMC=y
+CONFIG_ENV_IS_IN_SPI_FLASH=y
 CONFIG_SYS_RELOC_GD_ENV_ADDR=y
 CONFIG_NET_RANDOM_ETHADDR=y
 CONFIG_REGMAP=y
@@ -50,6 +52,7 @@ CONFIG_FASTBOOT_FLASH=y
 CONFIG_FASTBOOT_FLASH_MMC_DEV=0
 CONFIG_RCAR_GPIO=y
 CONFIG_RZG2L_GPIO=y
+CONFIG_DM = y
 CONFIG_DM_I2C=y
 CONFIG_SYS_I2C_RCAR_IIC=y
 CONFIG_SYS_I2C_RZG2L_RIIC=y
@@ -84,5 +87,12 @@ CONFIG_BOARD_LATE_INIT=y
 CONFIG_WDT=y
 CONFIG_RENESAS_RZG2LWDT=y
 CONFIG_CMD_WDT=y
-CONFIG_SYS_MMC_ENV_DEV=0
-CONFIG_SYS_MMC_ENV_PART=1
+CONFIG_SPI_FLASH=y
+CONFIG_SPI_FLASH_USE_4K_SECTORS=y
+CONFIG_SPI=y
+CONFIG_DM_SPI=y
+CONFIG_RENESAS_RPC_SPI=y
+CONFIG_CMD_SF=y
+CONFIG_CMD_SPI=y
+CONFIG_SPI_FLASH_MACRONIX=y
+CONFIG_DM_SPI_FLASH=y
+CONFIG_SYS_MMC_DEV=0
+CONFIG_SYS_MMC_IMG_LOAD_PART=1

diff --git a/include/configs/vkrzv2l.h b/include/configs/vkrzv2l.h
index f7d5b48b15..e55d67b054 100644
--- a/include/configs/vkrzv2l.h
+++ b/include/configs/vkrzv2l.h
@@ -97,8 +97,8 @@
 	DEFAULT_MMC_RZV2L_ARGS \
 	"fdtfile=" CONFIG_DEFAULT_FDT_FILE "\0" \
 	"image=Image \0" \
-	"mmcdev="__stringify(CONFIG_SYS_MMC_ENV_DEV)"\0" \
-	"mmcpart=" __stringify(CONFIG_SYS_MMC_ENV_PART) "\0" \
+	"mmcdev="__stringify(CONFIG_SYS_MMC_DEV)"\0" \
+	"mmcpart=" __stringify(CONFIG_SYS_MMC_IMG_LOAD_PART) "\0" \
 	"dtb_addr=0x48000000 \0" \
 	"image_addr=0x48080000 \0" \
 	"mmcbootargs=setenv bootargs rw rootwait earlycon root=/dev/mmcblk0p2 ${extrabootargs}\0" \
 
